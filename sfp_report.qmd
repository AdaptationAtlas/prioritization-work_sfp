---
title: "Sustainable Farming Program Prioritization Report"
format:
  typst:
    margin:
      x: 0.5cm
      y: 0.5cm

execute:
  echo: false
  warning: false
---

```{r}
#| include: false
library(terra)
library(sf)
library(tidyr)
library(ggplot2)
library(jsonlite)
library(dplyr)
library(patchwork)
library(readxl)
library(biscale)
library(nanoparquet)

fig_font_sz <- 17
urgency_data <- read_json("data/urgency.json")

a0_vect_simple <- vect("data/a0_vect_vsimple.topojson")
a0_sys_area <- read_parquet("data/results/bounds_area.parquet")
area_lookup <- read_parquet("data/results/mdata_area-lookup.parquet")
farm_sys <- rast("data/bounds_farmSys.tif")

grape_plt_yr <- read_parquet("./data/results/grape.parquet") |>
  subset(
    year == 2019
  )

urgency_df <- read_parquet("data/results/urgency.parquet")

aow1_digi <- read_parquet("data/results/aow1_digi.parquet")
aow1_need <- read_parquet("data/results/aow1_need.parquet")

aow2_shocks_idx <- read_parquet("data/results/aow2_shocks.parquet")
aow2_resilience_idx <- read_parquet("data/results/aow2_resilience.parquet")

aow3_constraints_idx <- read_parquet("data/results/aow3_constraints.parquet")
aow3_capacity_idx <- read_parquet("data/results/aow3_capacity.parquet")
```

# Introduction

## Boundary and Cropland Datasets

Administrative boundaries are provided at the national (admin0) level, derived
from the latest GAUL24 dataset. Results are available for three agricultural
system classifications: the original Dixon dataset with 46 classes, and two
FAO-derived versions with 8 classes each. We also apply an agricultural area
mask based on the _Global Livestock of the World_ (2015) dataset and global
cropland extent data.

## Urgency Index Calculation

The urgency index is calculated in the following steps:

1. Compute the total area and agricultural area by agricultural system, country,
   and system–country combination.
2. Read in the variable rasters and mask them to the agricultural area.
3. Classify each variable raster into low, moderate, and high categories based
   on predefined thresholds (with inversion where appropriate).
4. Determine the proportion of agricultural area falling within the high-risk
   category for each country and system.
5. Group variables into exposure and vulnerability categories; normalize their
   values and calculate the mean for each category to produce sub-indices.
6. Compute the final urgency index as the mean of the exposure and vulnerability
   sub-indices for each country and system.

The variables included in the index are:

```{r}
#| output: asis

gen_threshold_text <- function(x) {
  if (is.null(x$threshold)) {
    return("")
  } else {
    th <- x$threshold
    paste0(
      "  - Thresholds:\n",
      "    - Low: ",
      th$low,
      " - ",
      th$mid,
      "\n",
      "    - Moderate: ",
      th$mid,
      " - ",
      th$high,
      "\n",
      "    - High: > ",
      th$high
    )
  }
}

cat(paste0(
  lapply(urgency_data$variables, function(x) {
    paste0(
      "- **",
      x$title %||% x$var_name,
      "**\n",
      "  - Group: ",
      x$group,
      "\n",
      "  - Source: ",
      x$source,
      "\n",
      gen_threshold_text(x)
    )
  }),
  collapse = "\n"
))
```

## Local Capacity Analysis

This data comes from GRAPE (WUR-ERS Global Research on Agriculture). Values for
human resource used for agricultural R&D are normalized for comparison between
countries using rural population, and values for spending on agricultural R&D
are normalized between countries using agricultural GDP.

Agricultural R&D spending as a share of agricultural GDP—reflects how much
priority a government places on agricultural research. R&D human resource
capacity per rural capita—shows how that investment translates into available
research and outreach capacity at the population level. A government may invest
heavily in agricultural R&D, yet the benefits may not scale evenly across the
rural population.

## Area of Work Indices

For each area, key variables were selected to represent both need (where
services are most required) and capacity (where delivery is most feasible).
These indicators span agronomic, socioeconomic, infrastructural, and
institutional dimensions, and are normalized and aggregated into composite
indices. The steps involved are:

1. Gather data for the key variables at a national level. If data is in raster
   format, it is extracted to admin 0 boundaries. Otherwise the admin 0 data is
   used.
2. Datasets related to absolute values (VOP, research spending, number of
   farmers, etc.), are scaled based on total country agricultural area,
   agricultural GDP, or rural population to allow comparison between countries
   of different sizes and populations.
3. Some variables are inverted to reflect the direction of the other variables
   within the index.
4. Variables are normalized to a 0-1 scale.
5. Variables are aggregated into the need and capacity indices using arithmetic
   means.
6. Each index is classified into low, moderate, and high categories based on the
   distribution of the index values for visualization on the bivariate maps.

This approach enables targeting of interventions where impact is likely to be
both necessary and achievable.

### AOW1 - AI Enabled Advisories

The variables included in the Advisory Need Index are:

```{r}
#| output: asis
format_variable_summary <- function(variable_list) {
  cat(paste0(
    lapply(variable_list, function(x) {
      paste0(
        "- **",
        x$title %||% x$var_name,
        "**\n",
        "  - Source: ",
        x$source,
        "\n"
      )
    }),
    collapse = "\n"
  ))
}

advisory_need <- list(
  list(
    title = "Fertilizer Use Per Unit of Agricultural Production",
    source = "FAOSTAT"
  ),
  list(
    title = "Crop Value of Production Per Km^2",
    source = "MapSpam 2010"
  ),
  list(
    title = "Crop Yield Gap",
    source = "FAO GAEZ4"
  )
)

format_variable_summary(advisory_need)
```

The variables included in the Delivery Capacity Index are:

```{r}
#| output: asis
delivery_capacity <- list(
  list(
    title = "Weather Station Density (KDE)",
    source = "NOAA, OSCAR, WMO Networks"
  ),
  list(
    title = "Education Attainment",
    source = "University of Washington - IHME"
  ),
  list(
    title = "Internet Downlaod Speed",
    source = "OOKLA"
  ),
  list(
    title = "Ease of Doing Agri-business",
    source = "World Bank EBA"
  ),
  list(
    title = "Network Readiness Index",
    source = "Network Readiness Index"
  )
)

format_variable_summary(delivery_capacity)
```

### AOW2 - Managing Shocks

The variables included in the Shock Exposure Index are:

```{r}
#| output: asis
shock_exposure <- list(
  list(
    title = "Rainfall Variability (CV)",
    source = "CHIRPS"
  ),
  list(
    title = "Drought Frequency (number of years SPEI < -1)",
    source = "SPEI"
  ),
  list(
    title = "Flood Risk",
    source = "JRC Flood Hazard Map"
  ),
  list(
    title = "Pest and Disease Impact on Yield (ssp370 - 2100)",
    source = "Jason Rhor & lab (unpublished)"
  )
)
format_variable_summary(shock_exposure)
```

The variables included in the Resilience Capacity Index are:

```{r}
#| output: asis
resilience_capacity <- list(
  list(
    title = "Internet Download Speed",
    source = "OOKLA"
  ),
  list(
    title = "Gridded Relative Deprivation Index (GRDI)",
    source = "NASA SEDAC"
  ),
  list(
    title = "Rural Population Bank Account Ownership",
    source = "World Bank Findex"
  )
  # CIS variable still unknown — add here when defined
)
format_variable_summary(resilience_capacity)
```

### AOW3 - Binding Constraints and Opportunities

The variables included in the Constraint Burden Index are:

```{r}
#| output: asis
constraint_burden <- list(
  list(
    title = "Crop Diversity (Disease Proxy)",
    source = "FAO CropGrids & Shannon Diverisity Index"
  ),
  list(
    title = "Soil Carbon",
    source = "SoilGrids"
  ),
  list(
    title = "Soil pH",
    source = "SoilGrids"
  ),
  list(
    title = "Green Water Scarcity",
    source = "He L, Rosa L. Solutions to agricultural green water scarcity under climate change. (2023)"
  )
)
format_variable_summary(constraint_burden)
```

The variables included in the Enabling Environment Index are:

```{r}
#| output: asis
enabling_environment <- list(
  list(
    title = "Time to City (Market Access Proxy)",
    source = "Nelson et al. 2019"
  ),
  list(
    title = "Rural Population Density",
    source = "WorldPop & Global Human Settlement Layer"
  ),
  list(
    title = "Machinery Per Unit of Agricultural Land",
    source = "United States Department of Agriculture & Our World in Data"
  ),
  list(
    title = "Rural Population Bank Account Ownership",
    source = "World Bank Findex"
  )
)

format_variable_summary(enabling_environment)
```

::: {.landscape}

# Farm Sys Area by Country

```{r}
#| include: false
farm_sys_lvl <- levels(farm_sys)[[1]]
names(farm_sys_lvl) <- c("value", "land_use")

sys_labels <- setNames(
  # gsub("-|.(?=\\()", " ", farm_sys_lvl[[1]]$land_use, perl = TRUE),
  farm_sys_lvl$land_use,
  as.character(farm_sys_lvl$value)
)

a0_labels <- setNames(a0_vect_simple$gaul0_name, a0_vect_simple$gaul0_code)

# Get top systems
sys_totals <- aggregate(
  area_km2_ag ~ sys,
  data = a0_sys_area,
  sum,
  na.rm = TRUE
)
top_sys <- head(sys_totals[order(-sys_totals$area_km2_ag), "sys"], 15)
top_sys_names <- sys_labels[top_sys]
```

```{r}
#| column: page
#| fig-width: 21
#| fig-height: 14
#| fig-align: center
area_plot_data <- subset(a0_sys_area, sys %in% top_sys)
area_plot_data$sys <- sys_labels[area_plot_data$sys]

area_plot_data |>
  complete(
    a0 = unique(area_plot_data$a0), # fill missing values for pretty plot
    sys = unique(area_plot_data$sys)
  ) |>
  ggplot(aes(x = factor(sys), y = factor(a0), fill = area_km2_ag)) +
  geom_tile(color = "white", lwd = 1.5, linetype = 1) +
  scale_fill_viridis_c(name = "Area (km²)", na.value = "#eeee") +
  labs(
    x = "System code (sys)",
    # y = "Country code (a0)",
    y = NULL,
    title = "Area by Country and System"
  ) +
  scale_x_discrete(labels = scales::label_wrap(10)) +
  scale_y_discrete(labels = a0_labels) +
  theme_minimal(base_size = fig_font_sz)
```

# urgency_df

```{r}
#| include: false
# vars <- urgency_data$variables
#

plot_data <- subset(
  urgency_df,
  boundary_id == "a0_sys_id" & land_use %in% top_sys_names
)
```

```{r}
#| column: page
#| fig-width: 21
#| fig-height: 14
#| fig-align: center
plot_data$area <- area_lookup[
  match(plot_data$id, area_lookup$ID),
  "area_km2_ag"
]

plot_data |>
  complete(
    gaul0_code = unique(plot_data$gaul0_code),
    land_use = unique(plot_data$land_use)
  ) |>
  ggplot(aes(
    x = land_use,
    y = gaul0_code,
    size = area,
    fill = composite_index
  )) +
  geom_point(shape = 21, color = "white", stroke = 1.2) +
  scale_fill_viridis_c(
    name = "Urgency (0–1)",
    na.value = "#eeee",
    direction = -1
  ) +
  scale_size_continuous(name = "Area", range = c(3, 12)) +
  guides(
    size = guide_legend(
      override.aes = list(
        shape = 21,
        fill = "grey70"
      )
    ),
    fill = guide_colorbar()
  ) +
  labs(
    x = "System code (sys)",
    # y = "Country",
    y = NULL,
    title = "Urgency by Country and System (Bubble Size = Area)"
  ) +
  scale_y_discrete(labels = a0_labels) +
  scale_x_discrete(labels = scales::label_wrap(10)) +
  theme_minimal(base_size = fig_font_sz)
```

:::

```{r}
#| column: page
#| fig-height: 15
#| fig-align: center

urgency_df |>
  subset(boundary_id == "gaul0_code") |>
  mutate(
    cg_region = a0_vect_simple[
      match(gaul0_code, a0_vect_simple$gaul0_code),
    ]$cg_region
  ) |>
  ggplot(aes(
    x = composite_index,
    y = reorder(gaul0_code, composite_index),
    fill = cg_region
  )) +
  geom_bar(stat = "identity") +
  labs(
    x = "Index (0-1)",
    y = "Country",
    title = "Country Urgency Index"
  ) +
  scale_y_discrete(labels = a0_labels) +
  theme_minimal(base_size = fig_font_sz)

urgency_df |>
  subset(boundary_id == "gaul0_code") |>
  mutate(
    cg_region = a0_vect_simple[
      match(gaul0_code, a0_vect_simple$gaul0_code),
    ]$cg_region
  ) |>
  group_by(cg_region) |>
  slice_max(order_by = composite_index, n = 6) |> # top 5 per cg_region
  ungroup() |>
  ggplot(aes(
    x = composite_index,
    y = reorder(gaul0_code, composite_index),
    fill = cg_region
  )) +
  geom_bar(stat = "identity") +
  labs(
    x = "Index (0-1)",
    y = "Country",
    title = "Country Urgency Index"
  ) +
  scale_y_discrete(labels = a0_labels) +
  facet_wrap(~cg_region, scales = "free_y") + # facet by cg_region
  theme_minimal(base_size = fig_font_sz)
```

::: {.landscape}

```{r}
# Urgency Index Map
#| include: false
a0_df <- subset(urgency_df, boundary_id == "gaul0_code")
a0_df$iso3c <- a0_vect_simple$iso3_code[match(
  a0_df$gaul0_code,
  a0_vect_simple$gaul0_code
)]
a0_idx_sf <- merge(a0_vect_simple, a0_df, by = "gaul0_code")

# ggplot() +
#   geom_sf(data = st_as_sf(a0_idx_sf), aes(fill = composite_index)) +
#   geom_sf(data = st_as_sf(a0_vect_simple), fill = NA, color = "black") +
#   scale_fill_viridis_c(name = "Urgency (0-1)", na.value = "#eeee") +
#   theme_minimal(base_size = fig_font_sz)
```

:::

::: {.landscape}

## Bivariate Map of the Urgency Dimensions

Note on legend: High Exposure (blue) areas have high rural population density
and a higher agricultural production per km². High Vulnerability (orange)
regions have the greatest levels of poverty and lowest education.

```{r}
#| column: page
#| fig-width: 18
#| fig-height: 12
#| fig-align: center

urgency_bivar <- bi_class(
  a0_df,
  vuln_index,
  expo_index,
  style = "quantile",
  dim = 3
)
urgency_sf <- terra::merge(a0_vect_simple, urgency_bivar, by = "gaul0_code")

# Create the bivariate map using ggplot2
pallet <- "BlueOr"
bivar_map <- ggplot() +
  theme_void(base_size = 14) + # Set a minimal theme for the map
  geom_sf(data = sf::st_as_sf(urgency_sf), aes(fill = bi_class), color = NA) +
  geom_sf(
    data = st_as_sf(a0_vect_simple),
    color = "black",
    fill = NA,
    size = 0.2
  ) +
  # Apply the bivariate color scale using the selected palette and dimensions
  bi_scale_fill(pal = pallet, dim = 3, flip_axes = FALSE, rotate_pal = FALSE) +
  theme(legend.position = "none")

# Create the legend for the bivariate map
bivar_legend <- bi_legend(
  pal = pallet,
  flip_axes = FALSE,
  rotate_pal = FALSE,
  dim = 3,
  xlab = "Vulnerability",
  ylab = "Exposure",
  size = 10
) +
  theme(
    panel.background = element_blank(),
    plot.background = element_blank()
  )

# Combine the map and legend using patchwork
bivar_map +
  inset_element(bivar_legend, left = 0.5, bottom = 0, right = 0.9, top = 0.4)
```

:::

::: {.landscape}

## Bivariate Map of Country Financial/Research Capacity

```{r}
#| column: page
#| fig-width: 18
#| fig-height: 12
#| fig-align: center

grape_bivar <- bi_class(
  na.omit(grape_plt_yr),
  x = "rd_pct_gdp",
  y = "hr_per_rpop",
  style = "quantile",
  dim = 3
)
grape_plt_sf <- merge(
  a0_vect_simple,
  grape_bivar,
  by.x = "iso3_code",
  by.y = "iso3c"
)

bivar_map_grape <- ggplot() +
  theme_void(base_size = 14) + # Set a minimal theme for the map
  geom_sf(data = sf::st_as_sf(grape_plt_sf), aes(fill = bi_class), color = NA) +
  geom_sf(
    data = st_as_sf(a0_vect_simple),
    color = "black",
    fill = NA,
    size = 0.2
  ) +
  # Apply the bivariate color scale using the selected palette and dimensions
  bi_scale_fill(pal = pallet, dim = 3, flip_axes = FALSE, rotate_pal = FALSE) +
  theme(legend.position = "none")

# Create the legend for the bivariate map
bivar_legend_grape <- bi_legend(
  pal = pallet,
  flip_axes = FALSE,
  rotate_pal = FALSE,
  dim = 3,
  xlab = "Human Resource Capacity",
  ylab = "Ag R&D Spending",
  size = 10
) +
  theme(
    panel.background = element_blank(),
    plot.background = element_blank()
  )

# Combine the map and legend using patchwork
bivar_map_grape +
  inset_element(
    bivar_legend_grape,
    left = 0.5,
    bottom = 0,
    right = 0.9,
    top = 0.4
  )

# TODO: look at missing data for countries and see if that could be factor of ranking...
# add TODO within key binds
# Multi-code export interactive html?
```

:::

```{r}
#| column: page
#| fig-width: 15
#| fig-height: 15
#| fig-align: center

grape_plt_yr$cg_region <- a0_vect_simple$cg_region[
  match(grape_plt_yr$iso3c, a0_vect_simple$iso3_code)
]

grape_plt_yr$iso3_factor <- factor(grape_plt_yr$iso3c)

ggplot(
  data = grape_plt_yr,
  aes(
    x = rd_pct_gdp,
    y = reorder(iso3_factor, rd_pct_gdp),
    fill = cg_region
  )
) +
  geom_bar(stat = "identity") +
  labs(
    x = "Ag. R&D",
    y = "Country",
    title = "National Spending on Agricultural R&D relative to AG. GDP"
  ) +
  scale_y_discrete(labels = a0_labels) +
  theme_minimal(base_size = fig_font_sz)

ggplot(
  data = grape_plt_yr,
  aes(
    x = hr_per_rpop,
    y = reorder(iso3_factor, hr_per_rpop),
    fill = cg_region
  )
) +
  geom_bar(stat = "identity") +
  labs(
    x = "Human Resource avalability",
    y = "Country",
    title = "Human Resources for R&D per Rural Pop."
  ) +
  scale_y_discrete(labels = a0_labels) +
  theme_minimal(base_size = fig_font_sz)
```

::: {.landscape}

# AOW 1

Note on legend: Higher need (blue) is negative and high capacity (orange) is
positive

```{r}
#| include: false
# AOW 1 - Advisory Need
ggplot(
  aow1_need,
  aes(x = reorder(iso3, need_idx), fill = gaul0_code, y = need_idx)
) +
  geom_bar(stat = "identity")
```

```{r}
#| include: false
# AOW 1 - Delivery Capacity
ggplot(
  aow1_digi,
  aes(x = reorder(iso3c, capacity_idx), fill = gaul0_code, y = capacity_idx)
) +
  geom_bar(stat = "identity")
```

```{r}
#| column: page
#| fig-width: 18
#| fig-height: 12
#| fig-align: center

# bivariate map
aow1 <- merge(aow1_digi, aow1_need, by = "gaul0_code")[c(
  "gaul0_code",
  "capacity_idx",
  "need_idx"
)]

aow1_bivar <- bi_class(
  aow1,
  capacity_idx,
  need_idx,
  style = "quantile",
  dim = 3
)
aow1_sf <- terra::merge(a0_vect_simple, aow1_bivar, by = "gaul0_code")

# Create the bivariate map using ggplot2
pallet <- "BlueOr"
bivar_map1 <- ggplot() +
  theme_void(base_size = 14) + # Set a minimal theme for the map
  geom_sf(data = sf::st_as_sf(aow1_sf), aes(fill = bi_class), color = NA) +
  geom_sf(
    data = sf::st_as_sf(a0_vect_simple),
    color = "black",
    fill = NA,
    size = 0.2
  ) +
  # Apply the bivariate color scale using the selected palette and dimensions
  bi_scale_fill(pal = pallet, dim = 3, flip_axes = FALSE, rotate_pal = FALSE) +
  theme(legend.position = "none")

# Create the legend for the bivariate map
bivar_legend1 <- bi_legend(
  pal = pallet,
  flip_axes = FALSE,
  rotate_pal = FALSE,
  dim = 3,
  xlab = "Capacity",
  ylab = "Need",
  size = 10
) +
  theme(
    panel.background = element_blank(),
    plot.background = element_blank()
  )

# Combine the map and legend using patchwork
bivar_map1 +
  inset_element(bivar_legend1, left = 0.5, bottom = 0, right = 0.9, top = 0.4)
```

# AOW 2

Note on legend: High shock value (blue) is negative and High resilience (orange)
is positive

```{r}
#| output: false
# AOW 2 - Shock Exposure

# aow2_shocks_idx <- aow2_shocks |>
#   mutate(across(
#     -c(gaul0_code, iso3c),
#     ~ {
#       rng <- range(.x, na.rm = TRUE)
#       if (diff(rng) == 0) 0 else (.x - rng[1]) / diff(rng)
#     }
#   )) |>
#   mutate(shock_idx = rowMeans(across(-c(gaul0_code, iso3c)), na.rm = TRUE))

ggplot(aow2_shocks_idx, aes(x = shock_idx, y = reorder(iso3c, shock_idx))) +
  geom_col()
```

```{r}
#| column: page
#| fig-width: 18
#| fig-height: 12
#| fig-align: center

aow2 <- merge(aow2_shocks_idx, aow2_resilience_idx, by = c("gaul0_code"))[c(
  "gaul0_code",
  "shock_idx",
  "resilience_idx"
)]

aow2_bivar <- bi_class(
  aow2,
  resilience_idx,
  shock_idx,
  style = "quantile",
  dim = 3
)

aow2_sf <- terra::merge(a0_vect_simple, aow2_bivar, by = c("gaul0_code"))

# Create the bivariate map using ggplot2
pallet <- "BlueOr"
bivar_map2 <- ggplot() +
  theme_void(base_size = 14) + # Set a minimal theme for the map
  geom_sf(data = sf::st_as_sf(aow2_sf), aes(fill = bi_class), color = NA) +
  geom_sf(
    data = sf::st_as_sf(a0_vect_simple),
    color = "black",
    fill = NA,
    size = 0.2
  ) +
  # Apply the bivariate color scale using the selected palette and dimensions
  bi_scale_fill(pal = pallet, dim = 3, flip_axes = FALSE, rotate_pal = FALSE) +
  theme(legend.position = "none")

# Create the legend for the bivariate map
bivar_legend2 <- bi_legend(
  pal = pallet,
  flip_axes = FALSE,
  rotate_pal = FALSE,
  dim = 3,
  xlab = "Resilience",
  ylab = "Shocks",
  size = 10
) +
  theme(
    panel.background = element_blank(),
    plot.background = element_blank()
  )

# Combine the map and legend using patchwork
bivar_map2 +
  inset_element(bivar_legend2, left = 0.5, bottom = 0, right = 0.9, top = 0.4)
```

# AOW 3

Note on legend: Higher constraints (blue) is negative and high capacity (orange)
is positive

```{r}
#| output: false

## AOW 3 - Constraint Burden
# High = bad
ggplot(
  aow3_constraints_idx,
  aes(x = constraint_idx, y = reorder(iso3c, constraint_idx))
) +
  geom_col()
```

```{r}
#| output: false
# AOW 3 - Enabling Environment
# positive = good
ggplot(
  aow3_capacity_idx,
  aes(x = capacity_idx, y = reorder(iso3c, capacity_idx))
) +
  geom_col()
```

```{r}
#| column: page
#| fig-width: 18
#| fig-height: 12
#| fig-align: center

aow3 <- merge(aow3_constraints_idx, aow3_capacity_idx, by = c("gaul0_code"))[c(
  "gaul0_code",
  "constraint_idx",
  "capacity_idx"
)]

aow3_bivar <- bi_class(
  aow3,
  capacity_idx,
  constraint_idx,
  style = "quantile",
  dim = 3
)

aow3_sf <- terra::merge(a0_vect_simple, aow3_bivar, by = c("gaul0_code"))

bivar_map3 <- ggplot() +
  theme_void(base_size = 14) + # Set a minimal theme for the map
  geom_sf(data = sf::st_as_sf(aow3_sf), aes(fill = bi_class), color = NA) +
  geom_sf(
    data = sf::st_as_sf(a0_vect_simple),
    color = "black",
    fill = NA,
    size = 0.2
  ) +
  # Apply the bivariate color scale using the selected palette and dimensions
  bi_scale_fill(pal = pallet, dim = 3, flip_axes = FALSE, rotate_pal = FALSE) +
  theme(legend.position = "none")

# Create the legend for the bivariate map
bivar_legend3 <- bi_legend(
  pal = pallet,
  flip_axes = FALSE,
  rotate_pal = FALSE,
  dim = 3,
  xlab = "Capacity",
  ylab = "Constraints",
  size = 10
) +
  theme(
    panel.background = element_blank(),
    plot.background = element_blank()
  )

# Combine the map and legend using patchwork
bivar_map3 +
  inset_element(bivar_legend3, left = 0.5, bottom = 0, right = 0.9, top = 0.4)
```

:::

## Discussion Points

### Farm System vs. Crop production systems

There has been a lot of discussion about how to prioritize countries between or
based on system. There needs to be a general consensus on where this step takes
place, if the prioritization is based on crop or Dixon/similar system, and how
crop-systems would be defined for each area (k-means clustering, top 3 crops,
etc).

### Thresholds

If we use the current approach, the group should agree on thresholds for
variables. If thresholds are not set the variables will be classed and
normalized based on their distributions

### Variables Included

The above variables were included based on availability and relevance. A
preference was given to variables that were available in raster format or as
sub-national data rather than admin 0 data. There should be agreement on the
variables included and variables can be added and removed as needed.
